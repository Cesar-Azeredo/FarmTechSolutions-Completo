# üí° Exemplos Pr√°ticos - Scripts R

**Casos de Uso Reais e Exemplos Avan√ßados**

Esta documenta√ß√£o fornece exemplos pr√°ticos detalhados de como usar e estender os scripts R do FarmTech Solutions para diferentes cen√°rios agr√≠colas.

## üìã √çndice
1. [Cen√°rios B√°sicos](#cen√°rios-b√°sicos)
2. [Casos de Uso Avan√ßados](#casos-de-uso-avan√ßados)
3. [Integra√ß√µes](#integra√ß√µes)
4. [Personaliza√ß√µes](#personaliza√ß√µes)
5. [Troubleshooting com Exemplos](#troubleshooting-com-exemplos)

## üå± Cen√°rios B√°sicos

### Cen√°rio 1: Primeira An√°lise de Dados

#### Situa√ß√£o
Voc√™ acabou de coletar dados de 10 planta√ß√µes de banana e quer entender as caracter√≠sticas b√°sicas.

#### Dados de Exemplo (banana.csv)
```csv
comprimento,largura,nome_insumo,qtd_insumo,unidade,area,figura
120.5,80.2,"Fosfato",965.61,"kg",9656.1,"Ret√¢ngulo"
95.0,60.5,"Nitrog√™nio",574.75,"kg",5747.5,"Ret√¢ngulo"
150.3,90.7,"Pot√°ssio",1363.21,"kg",13632.1,"Ret√¢ngulo"
110.0,75.0,"Herbicida",825.0,"L",8250.0,"Ret√¢ngulo"
88.5,55.2,"Inseticida",488.52,"mL",4885.2,"Ret√¢ngulo"
```

#### Execu√ß√£o
```bash
cd FarmTechSolutions/r_app
Rscript analise.R
```

#### Sa√≠da Esperada
```
--- Estat√≠sticas Banana ---
M√©dia comprimento: 112.86
Desvio padr√£o comprimento: 24.73
M√©dia largura: 72.32
Desvio padr√£o largura: 14.91
M√©dia qtd_insumo: 843.42
Desvio padr√£o qtd_insumo: 371.84
```

#### Interpreta√ß√£o
- **Comprimento m√©dio**: 112.86m indica terrenos de tamanho m√©dio
- **Alto desvio padr√£o**: Variabilidade significativa entre planta√ß√µes
- **Quantidade de insumo**: Proporcional √† √°rea (boa correla√ß√£o)

### Cen√°rio 2: Monitoramento Clim√°tico Regional

#### Situa√ß√£o
Precisa verificar condi√ß√µes clim√°ticas para decidir sobre aplica√ß√£o de defensivos.

#### Execu√ß√£o para Banana
```bash
Rscript clima.R banana
```

#### Sa√≠da Esperada
```
Tempo atual em S√£o Paulo:
Temperatura: 23.5¬∞C
Vento: 12.3km/h
Condi√ß√£o: 2

Cidades com plantio de banana:
- Registro
- Juqui√°
- Sete Barras
- Miracatu
- Iguape
```

#### Tomada de Decis√£o
- **Temperatura 23.5¬∞C**: Ideal para aplica√ß√µes
- **Vento 12.3km/h**: Moderado, adequado
- **Condi√ß√£o 2**: Parcialmente nublado, seguro para pulveriza√ß√£o

## üöÄ Casos de Uso Avan√ßados

### Caso 1: An√°lise Comparativa Sazonal

#### Criando Script Personalizado (analise_sazonal.R)
```r
library(readr)

# Carregar dados hist√≥ricos
banana_q1 <- read_csv("../python_app/historico/banana_q1_2025.csv", show_col_types = FALSE)
banana_q2 <- read_csv("../python_app/historico/banana_q2_2025.csv", show_col_types = FALSE)

# Fun√ß√£o para calcular estat√≠sticas
calcular_stats <- function(dados, periodo) {
  cat(sprintf("\n--- Estat√≠sticas %s ---\n", periodo))
  cat('M√©dia √°rea:', mean(dados$area), '\n')
  cat('M√©dia insumo:', mean(dados$qtd_insumo), '\n')
  
  # Retornar para compara√ß√£o
  return(list(
    area_media = mean(dados$area),
    insumo_medio = mean(dados$qtd_insumo)
  ))
}

# An√°lise comparativa
stats_q1 <- calcular_stats(banana_q1, "Q1 2025")
stats_q2 <- calcular_stats(banana_q2, "Q2 2025")

# Compara√ß√£o
diferenca_area <- stats_q2$area_media - stats_q1$area_media
diferenca_insumo <- stats_q2$insumo_medio - stats_q1$insumo_medio

cat("\n--- Compara√ß√£o Sazonal ---\n")
cat('Varia√ß√£o √°rea Q1‚ÜíQ2:', diferenca_area, 'm¬≤\n')
cat('Varia√ß√£o insumo Q1‚ÜíQ2:', diferenca_insumo, 'unidades\n')

if (diferenca_area > 0) {
  cat('üìà Expans√£o da √°rea plantada\n')
} else {
  cat('üìâ Redu√ß√£o da √°rea plantada\n')
}
```

### Caso 2: Alerta Meteorol√≥gico Automatizado

#### Script de Monitoramento (alerta_clima.R)
```r
library(httr)

# Configura√ß√£o de limites
TEMP_MAX <- 35  # ¬∞C
VENTO_MAX <- 25 # km/h
CODES_PERIGOSOS <- c(51:67, 71:86, 95:99)  # Chuva, neve, tempestade

# Fun√ß√£o de verifica√ß√£o
verificar_condicoes <- function(lat, lon, nome_local) {
  url <- paste0('https://api.open-meteo.com/v1/forecast?latitude=', lat,
                '&longitude=', lon, '&current_weather=true')
  
  res <- GET(url)
  if (status_code(res) != 200) {
    cat("‚ùå Erro ao acessar dados para", nome_local, "\n")
    return(FALSE)
  }
  
  dados <- content(res, as='parsed')
  temp <- dados$current_weather$temperature
  vento <- dados$current_weather$windspeed
  codigo <- dados$current_weather$weathercode
  
  # Verificar alertas
  alertas <- c()
  
  if (temp > TEMP_MAX) {
    alertas <- c(alertas, paste("üå°Ô∏è Temperatura alta:", temp, "¬∞C"))
  }
  
  if (vento > VENTO_MAX) {
    alertas <- c(alertas, paste("üí® Vento forte:", vento, "km/h"))
  }
  
  if (codigo %in% CODES_PERIGOSOS) {
    alertas <- c(alertas, paste("‚õàÔ∏è Condi√ß√£o adversa:", codigo))
  }
  
  # Relat√≥rio
  if (length(alertas) > 0) {
    cat("üö® ALERTAS PARA", nome_local, ":\n")
    for (alerta in alertas) {
      cat("  ", alerta, "\n")
    }
    return(TRUE)
  } else {
    cat("‚úÖ", nome_local, "- Condi√ß√µes normais\n")
    return(FALSE)
  }
}

# Coordenadas das fazendas
fazendas <- data.frame(
  nome = c("Fazenda Norte", "Fazenda Sul", "Fazenda Central"),
  lat = c(-23.55, -25.43, -21.78),
  lon = c(-46.63, -49.27, -43.91)
)

# Verificar todas as fazendas
cat("=== RELAT√ìRIO METEOROL√ìGICO ===\n")
cat("Data/Hora:", format(Sys.time(), "%Y-%m-%d %H:%M"), "\n\n")

alertas_ativos <- 0
for (i in 1:nrow(fazendas)) {
  if (verificar_condicoes(fazendas$lat[i], fazendas$lon[i], fazendas$nome[i])) {
    alertas_ativos <- alertas_ativos + 1
  }
}

cat("\nüìä RESUMO:", alertas_ativos, "de", nrow(fazendas), "fazendas com alertas\n")
```

### Caso 3: Relat√≥rio Automatizado de Produtividade

#### Script de Relat√≥rio (relatorio_produtividade.R)
```r
library(readr)

# Fun√ß√£o para calcular m√©tricas de produtividade
calcular_produtividade <- function(cultura) {
  arquivo <- paste0("../python_app/", cultura, ".csv")
  
  if (!file.exists(arquivo)) {
    cat("‚ùå Arquivo n√£o encontrado:", arquivo, "\n")
    return(NULL)
  }
  
  dados <- read_csv(arquivo, show_col_types = FALSE)
  
  # M√©tricas calculadas
  area_total <- sum(dados$area)
  insumo_total <- sum(dados$qtd_insumo)
  area_media <- mean(dados$area)
  eficiencia <- insumo_total / area_total  # insumo por m¬≤
  
  # An√°lise por tipo de insumo
  tipos_insumo <- table(dados$nome_insumo)
  insumo_predominante <- names(tipos_insumo)[which.max(tipos_insumo)]
  
  return(list(
    cultura = cultura,
    registros = nrow(dados),
    area_total = area_total,
    area_media = area_media,
    insumo_total = insumo_total,
    eficiencia = eficiencia,
    insumo_predominante = insumo_predominante
  ))
}

# Gerar relat√≥rio completo
gerar_relatorio <- function() {
  cat("=== RELAT√ìRIO DE PRODUTIVIDADE FARMTECH ===\n")
  cat("Gerado em:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")
  
  culturas <- c("banana", "milho")
  
  for (cultura in culturas) {
    cat("üå±", toupper(cultura), "\n")
    cat(rep("-", 40), "\n", sep="")
    
    prod <- calcular_produtividade(cultura)
    
    if (!is.null(prod)) {
      cat(sprintf("üìä Registros: %d\n", prod$registros))
      cat(sprintf("üìê √Årea total: %.2f m¬≤\n", prod$area_total))
      cat(sprintf("üìè √Årea m√©dia: %.2f m¬≤\n", prod$area_media))
      cat(sprintf("üß™ Insumo total: %.2f unidades\n", prod$insumo_total))
      cat(sprintf("‚ö° Efici√™ncia: %.4f insumo/m¬≤\n", prod$eficiencia))
      cat(sprintf("ü•á Insumo predominante: %s\n", prod$insumo_predominante))
      
      # Classifica√ß√£o de efici√™ncia
      if (prod$eficiencia < 0.1) {
        cat("üü¢ Efici√™ncia: ALTA\n")
      } else if (prod$eficiencia < 0.2) {
        cat("üü° Efici√™ncia: M√âDIA\n")
      } else {
        cat("üî¥ Efici√™ncia: BAIXA\n")
      }
    }
    cat("\n")
  }
  
  cat("üìà Recomenda√ß√µes baseadas nos dados dispon√≠veis em TECHNICAL_DOCS_R.md\n")
}

# Executar relat√≥rio
gerar_relatorio()
```

## üîó Integra√ß√µes

### Integra√ß√£o 1: Python + R Pipeline

#### Script Python (executar_analise_completa.py)
```python
import subprocess
import os
import json
from datetime import datetime

def executar_pipeline_completo():
    """Pipeline completo: Python ‚Üí CSV ‚Üí R ‚Üí Relat√≥rio"""
    
    print("üöÄ Iniciando pipeline FarmTech Solutions")
    
    # 1. Gerar dados Python
    print("üìä Gerando dados com Python...")
    resultado_python = subprocess.run(
        ["python", "python_app/main.py"], 
        capture_output=True, text=True, input="5\n"  # Sair automaticamente
    )
    
    # 2. Executar an√°lise R
    print("üìà Executando an√°lise estat√≠stica...")
    resultado_r = subprocess.run(
        ["Rscript", "r_app/analise.R"], 
        capture_output=True, text=True, cwd="."
    )
    
    # 3. Coletar dados meteorol√≥gicos
    print("üå§Ô∏è Coletando dados meteorol√≥gicos...")
    resultado_clima = subprocess.run(
        ["Rscript", "r_app/clima.R", "banana"], 
        capture_output=True, text=True, cwd="."
    )
    
    # 4. Compilar relat√≥rio
    relatorio = {
        "timestamp": datetime.now().isoformat(),
        "analise_estatistica": resultado_r.stdout,
        "dados_clima": resultado_clima.stdout,
        "status": "completo"
    }
    
    # 5. Salvar relat√≥rio JSON
    with open("relatorio_completo.json", "w") as f:
        json.dump(relatorio, f, indent=2)
    
    print("‚úÖ Pipeline conclu√≠do! Relat√≥rio salvo em relatorio_completo.json")
    
    return relatorio

if __name__ == "__main__":
    executar_pipeline_completo()
```

### Integra√ß√£o 2: Dashboard Web Simples

#### Script R para Web (dashboard_simples.R)
```r
# Instalar se necess√°rio: install.packages("httpuv")
library(httpuv)

# Fun√ß√£o para gerar HTML com dados
gerar_html_dashboard <- function() {
  # Executar an√°lises
  source("analise.R")
  
  # Capturar sa√≠da (simplificado)
  banana <- read_csv("../python_app/banana.csv", show_col_types = FALSE)
  
  html <- paste0(
    "<!DOCTYPE html>",
    "<html><head><title>FarmTech Dashboard</title></head>",
    "<body style='font-family: Arial, sans-serif; margin: 40px;'>",
    "<h1>üöú FarmTech Solutions Dashboard</h1>",
    "<h2>üìä Estat√≠sticas Banana</h2>",
    "<ul>",
    "<li>Registros: ", nrow(banana), "</li>",
    "<li>√Årea m√©dia: ", round(mean(banana$area), 2), " m¬≤</li>",
    "<li>Insumo m√©dio: ", round(mean(banana$qtd_insumo), 2), "</li>",
    "</ul>",
    "<p><em>Atualizado em: ", Sys.time(), "</em></p>",
    "</body></html>"
  )
  
  return(html)
}

# Servidor HTTP simples
servidor <- startServer("127.0.0.1", 8080, list(
  call = function(req) {
    list(
      status = 200L,
      headers = list('Content-Type' = 'text/html'),
      body = gerar_html_dashboard()
    )
  }
))

cat("üåê Dashboard dispon√≠vel em: http://localhost:8080\n")
cat("Pressione Ctrl+C para parar\n")

# Manter servidor ativo
while (TRUE) {
  service()
  Sys.sleep(1)
}
```

## üé® Personaliza√ß√µes

### Personaliza√ß√£o 1: Novas Culturas

#### Adicionando Cultura de Soja
```r
# Modificar clima.R - adicionar na lista de cidades
cidades_plantio <- list(
  banana = c("Registro", "Juqui√°", "Sete Barras", "Miracatu", "Iguape"),
  milho = c("Sorriso", "Lucas do Rio Verde", "Primavera do Leste", "Una√≠", "Rio Verde"),
  soja = c("Campo Grande", "Dourados", "Chapad√£o do Sul", "Maracaju", "Sidrol√¢ndia")
)

# Modificar analise.R - adicionar leitura de soja.csv
if (file.exists('../python_app/soja.csv')) {
  soja <- read_csv('../python_app/soja.csv', show_col_types = FALSE)
  
  cat('\n--- Estat√≠sticas Soja ---\n')
  cat('M√©dia √°rea:', mean(soja$area), '\n')
  cat('Desvio padr√£o √°rea:', sd(soja$area), '\n')
  cat('M√©dia qtd_insumo:', mean(soja$qtd_insumo), '\n')
  cat('Desvio padr√£o qtd_insumo:', sd(soja$qtd_insumo), '\n')
}
```

### Personaliza√ß√£o 2: M√©tricas Customizadas

#### Script de M√©tricas Avan√ßadas (metricas_custom.R)
```r
library(readr)

# Fun√ß√£o para an√°lise de efici√™ncia por hectare
analisar_eficiencia_hectare <- function(dados) {
  dados$area_hectare <- dados$area / 10000  # Converter m¬≤ para hectare
  dados$insumo_por_hectare <- dados$qtd_insumo / dados$area_hectare
  
  # Classificar efici√™ncia
  dados$classe_eficiencia <- cut(
    dados$insumo_por_hectare,
    breaks = c(0, 100, 200, 300, Inf),
    labels = c("Muito Eficiente", "Eficiente", "Moderado", "Ineficiente")
  )
  
  # Estat√≠sticas por classe
  table(dados$classe_eficiencia)
}

# Fun√ß√£o para an√°lise de outliers
detectar_outliers <- function(dados, coluna) {
  Q1 <- quantile(dados[[coluna]], 0.25, na.rm = TRUE)
  Q3 <- quantile(dados[[coluna]], 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  
  limite_inferior <- Q1 - 1.5 * IQR
  limite_superior <- Q3 + 1.5 * IQR
  
  outliers <- dados[[coluna]] < limite_inferior | dados[[coluna]] > limite_superior
  
  cat("Outliers em", coluna, ":\n")
  cat("Detectados:", sum(outliers, na.rm = TRUE), "de", length(dados[[coluna]]), "\n")
  
  if (sum(outliers, na.rm = TRUE) > 0) {
    cat("Valores:", dados[[coluna]][outliers], "\n")
  }
  
  return(outliers)
}

# Executar an√°lises customizadas
banana <- read_csv("../python_app/banana.csv", show_col_types = FALSE)

cat("=== AN√ÅLISE DE EFICI√äNCIA ===\n")
print(analisar_eficiencia_hectare(banana))

cat("\n=== DETEC√á√ÉO DE OUTLIERS ===\n")
detectar_outliers(banana, "area")
detectar_outliers(banana, "qtd_insumo")
```

## üîß Troubleshooting com Exemplos

### Problema 1: Dados Inconsistentes

#### Situa√ß√£o
CSV com valores negativos ou nulos.

#### Script de Limpeza (limpar_dados.R)
```r
library(readr)

limpar_csv <- function(arquivo) {
  cat("Limpando arquivo:", arquivo, "\n")
  
  dados <- read_csv(arquivo, show_col_types = FALSE)
  dados_originais <- nrow(dados)
  
  # Remover linhas com valores negativos
  dados <- dados[dados$area > 0, ]
  dados <- dados[dados$qtd_insumo > 0, ]
  
  # Remover valores nulos
  dados <- dados[complete.cases(dados), ]
  
  dados_finais <- nrow(dados)
  removidos <- dados_originais - dados_finais
  
  cat("Registros originais:", dados_originais, "\n")
  cat("Registros limpos:", dados_finais, "\n")
  cat("Removidos:", removidos, "\n")
  
  # Salvar arquivo limpo
  arquivo_limpo <- sub("\\.csv$", "_limpo.csv", arquivo)
  write_csv(dados, arquivo_limpo)
  
  cat("Arquivo limpo salvo:", arquivo_limpo, "\n")
}

# Usar: limpar_csv("../python_app/banana.csv")
```

### Problema 2: API Indispon√≠vel

#### Script com Fallback (clima_robusto.R)
```r
library(httr)

obter_clima_com_fallback <- function(lat, lon) {
  # Tentar API principal
  url_principal <- paste0('https://api.open-meteo.com/v1/forecast?latitude=', lat,
                         '&longitude=', lon, '&current_weather=true')
  
  tryCatch({
    res <- GET(url_principal, timeout(10))
    if (status_code(res) == 200) {
      return(content(res, as='parsed'))
    }
  }, error = function(e) {
    cat("Erro na API principal:", e$message, "\n")
  })
  
  # Fallback: dados simulados baseados em m√©dias hist√≥ricas
  cat("‚ö†Ô∏è Usando dados de fallback (m√©dias hist√≥ricas)\n")
  
  fallback_data <- list(
    current_weather = list(
      temperature = 23.5,  # M√©dia para S√£o Paulo
      windspeed = 12.0,
      weathercode = 1
    )
  )
  
  return(fallback_data)
}

# Testar fun√ß√£o
dados <- obter_clima_com_fallback(-23.55, -46.63)
cat("Temperatura:", dados$current_weather$temperature, "¬∞C\n")
```

### Problema 3: Performance com Datasets Grandes

#### Script Otimizado (analise_otimizada.R)
```r
library(readr)

# Para datasets > 100MB
analisar_dataset_grande <- function(arquivo) {
  cat("Analisando dataset grande:", arquivo, "\n")
  
  # Ler apenas colunas necess√°rias
  dados <- read_csv(arquivo, 
                   col_select = c("area", "qtd_insumo", "nome_insumo"),
                   show_col_types = FALSE)
  
  # Usar fun√ß√µes vetorizadas
  stats <- list(
    registros = nrow(dados),
    area_total = sum(dados$area),
    area_media = mean(dados$area),
    insumo_total = sum(dados$qtd_insumo),
    insumo_medio = mean(dados$qtd_insumo)
  )
  
  # Processamento em chunks para economia de mem√≥ria
  chunk_size <- 10000
  n_chunks <- ceiling(nrow(dados) / chunk_size)
  
  cat("Processando em", n_chunks, "chunks de", chunk_size, "registros\n")
  
  for (i in 1:n_chunks) {
    inicio <- (i-1) * chunk_size + 1
    fim <- min(i * chunk_size, nrow(dados))
    chunk <- dados[inicio:fim, ]
    
    # Processamento do chunk
    cat("Chunk", i, ":", fim - inicio + 1, "registros\n")
  }
  
  return(stats)
}
```

---

## üìä Resultados Esperados por Cen√°rio

### An√°lise B√°sica (10-50 registros)
- **Tempo de execu√ß√£o**: < 1 segundo
- **Estat√≠sticas**: M√©dias e desvios padr√£o b√°sicos
- **Uso de mem√≥ria**: < 50MB

### An√°lise Avan√ßada (100-1000 registros)  
- **Tempo de execu√ß√£o**: 1-5 segundos
- **Estat√≠sticas**: Incluindo outliers e correla√ß√µes
- **Uso de mem√≥ria**: 50-200MB

### An√°lise de Produ√ß√£o (1000+ registros)
- **Tempo de execu√ß√£o**: 5-30 segundos
- **Estat√≠sticas**: An√°lise completa com chunks
- **Uso de mem√≥ria**: Otimizada para < 500MB

---

**Exemplos Pr√°ticos R v1.0.0**
*Casos reais para agricultura de precis√£o* üìäüå±

**Pr√≥ximos passos**: Consulte [TECHNICAL_DOCS_R.md](./TECHNICAL_DOCS_R.md) para detalhes avan√ßados
